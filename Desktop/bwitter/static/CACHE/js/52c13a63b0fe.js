;window.onload=function(){var dweets=document.querySelectorAll('.dweet');var dweetiframes=document.querySelectorAll('.dweetiframe');var editor=document.querySelector('#editor');var editoriframe=document.querySelector('#preview-iframe');var oldCode=editor&&editor.value;addEventListener('message',receiveMessage,false);[].forEach.call(dweetiframes,function(iframe){registerWaypoint(iframe);});[].forEach.call(dweets,function(dweet){registerOnKeyListener(dweet);registerStatsClickListeners(dweet);});window.onmessage=function(event){var recordButton;if(event.data.msg==='finished'){recordButton=document.getElementById('record-'+event.data.dweetId);recordButton.classList.remove('processing');recordButton.getElementsByTagName('span')[0].innerHTML='record';}};if(editor&&editoriframe){showCode(editoriframe,oldCode);editor.addEventListener('keyup',function(){if(editor.value===oldCode){return;}
editor.size=Math.max(editor.value.length,1);showCode(editoriframe,editor.value);oldCode=editor.value;});}
new Waypoint.Infinite({element:$('.dweet-feed')[0],items:'.dweet-wrapper, .loading, .end-of-feed',more:'.next-page',onAfterPageLoad:function(items){$('.loading:not(:last-of-type)').hide();function requestFullscreen(el){(el.mozRequestFullScreen||el.webkitRequestFullscreen||el.requestFullscreen).call(el);}
$.each(items,function(index,div){var iframe=$(div).find('.dweetiframe')[0];var link=$(div).find('.fullscreen-button');var timestamp=$(div).find('time');var postedDate=moment.utc(timestamp.attr('datetime'));registerOnKeyListener(div);registerStatsClickListeners(div);registerWaypoint(iframe);link.on('click',function(e){e.preventDefault();requestFullscreen(iframe);});moment.locale(navigator.userLanguage||navigator.language||'en-US');timestamp.text(postedDate.local().format('lll'));});},});};function receiveMessage(event){var origin=event.origin||event.originalEvent.origin;if(origin!=='http://dweet.localhost:8000'&&origin!=='https://dweet.dwitter.net'&&origin!=='https://dweet.localhost:8000'){return;}
if(event.data.type==='error'){displayError(event.data.location,event.data.error);}}
function displayError(iframeurl,e){$('iframe[src^="'+iframeurl+'"]').closest('.dweet').find('.error-display')[0].innerText=e;}
function registerWaypoint(iframe){new Waypoint.Inview({element:iframe,entered:function(){play(iframe);},exit:function(){var fullscreenElement=(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement);if(fullscreenElement!==iframe){pause(iframe);}},});}
function play(iframe){var dweetwin=iframe.contentWindow||iframe;dweetwin.postMessage('play','*');}
function pause(iframe){var dweetwin=iframe.contentWindow||iframe;dweetwin.postMessage('pause','*');}
function showCode(iframe,code){var dweetwin=iframe.contentWindow||iframe;dweetwin.postMessage('code '+code,'*');}
function showStats(dweet,iframe){(iframe.contentWindow||iframe).postMessage('showStats','*');$(dweet).find('.show-stats').hide();$(dweet).find('.hide-stats').show();}
function hideStats(dweet,iframe){(iframe.contentWindow||iframe).postMessage('hideStats','*');$(dweet).find('.show-stats').show();$(dweet).find('.hide-stats').hide();}
function registerOnKeyListener(dweet){var iframe=$(dweet).find('.dweetiframe')[0];var editor=$(dweet).find('.code-input')[0];var changedDweetMenu=$(dweet).find('.dweet-changed');var submitButton=$(dweet).find('.remix-button,.dweet-button')[0];var captionField=$(dweet).find('.new-dweet-comment-input')[0];var captionFieldDisabled='Change the code...';var captionFieldEnabled=$(captionField).prop('placeholder');var oldCode=editor.value;var originalCode=oldCode;showCode(iframe,oldCode);editor.addEventListener('focus',function(){changedDweetMenu.show();if(editor.value===originalCode){$(submitButton).prop('disabled',true);$(captionField).prop('placeholder',captionFieldDisabled);}});editor.addEventListener('keyup',function(){showStats(dweet,iframe);changedDweetMenu.show();if(editor.value===originalCode){$(submitButton).prop('disabled',true);$(captionField).prop('placeholder',captionFieldDisabled);}else{$(submitButton).prop('disabled',false);$(captionField).prop('placeholder',captionFieldEnabled);}
if(editor.value===oldCode){return;}
editor.size=Math.max(editor.value.length,1);showCode(iframe,editor.value);oldCode=editor.value;});}
function registerStatsClickListeners(element){var iframe=$(element).find('.dweetiframe')[0];$(element).find('.show-stats').click(function(e){e.preventDefault();showStats(element,iframe);});$(element).find('.hide-stats').click(function(e){e.preventDefault();hideStats(element,iframe);});}
(function(){var lastScrollTop=null;var isHidden=false;window.addEventListener('scroll',function(){var newScrollTop=$(this).scrollTop();var newHiddenState=getHeaderHiddenState(lastScrollTop,newScrollTop);if(newHiddenState!==null&&newHiddenState!==isHidden){isHidden=newHiddenState;$('.head-menu').toggleClass('hidden',isHidden);}
lastScrollTop=newScrollTop;});}());function getHeaderHiddenState(lastScrollTop,newScrollTop){if(lastScrollTop===null){return null;}
if(newScrollTop>lastScrollTop&&newScrollTop>85){return true;}
if(newScrollTop<lastScrollTop){return false;}
return null;};function processLike(e){var $likeForm=$(this);var dweetId=$likeForm.data('dweet_id');var $likeButton=$likeForm.find('.like-button');var processServerResponse=function(response){if(response.not_authenticated){$likeForm.parent().parent().find('.error-display')[0].innerText='You have to be logged in to vote';}else{$likeButton.find('.score-text').html(response.likes);if(response.liked){$likeButton.addClass('liked');}else{$likeButton.removeClass('liked');}}};var config={url:'/d/'+dweetId+'/like',dataType:'json',method:'POST',headers:{'X-CSRFToken':$likeForm.data('csrf'),},success:processServerResponse,};e.preventDefault();$.ajax(config);}
function processReport(e){var $reportForm;var dweetId;var commentId;var processServerResponse;var config;e.preventDefault();if(!confirm('Are you sure you want to report this to a moderator?')){return;}
$reportForm=$(this);dweetId=$reportForm.data('dweet_id');commentId=$reportForm.data('comment_id');processServerResponse=function(response){if(response.not_authenticated){alert('You have to be logged in to report.');}else{alert('A moderator has been notified.');}};config={dataType:'json',method:'POST',headers:{'X-CSRFToken':$reportForm.data('csrf'),},success:processServerResponse,};if(dweetId){config.url='/d/'+dweetId+'/report';}else{config.url='/c/'+commentId+'/report';}
$.ajax(config);}
function getCommentHTML(comment){return'<li class=comment><a class=comment-name href="/u/'+comment.author+'">'+
comment.author+':</a> '+'<form class="report" data-comment_id="'+comment.id+'">'+'<button type="submit" class="report-button">'+'<div class="wrapper">'+'<span class="far fa-flag"></span>'+'<span class="text">report</span>'+'</div>'+'</button>'+'</form>'+'<span class="comment-message">'+comment.urlized_text+'</span>'+'</li>';}
function postComment(e){var $postForm=$(this);var dweetId=$postForm.data('dweet_id');var csrf=$postForm.data('csrf');var $commentText=$postForm.find('.comment-input');var $commentSection=$postForm.closest('.comment-section').children('.comments');var postCommentSuccess=function(response){$commentText[0].value='';$commentSection[0].innerHTML+=getCommentHTML(response);};var postCommentError=function(){};var comment={reply_to:dweetId,text:$commentText[0].value,csrfmiddlewaretoken:csrf,};var config={url:'/api/comments/',method:'POST',success:postCommentSuccess,error:postCommentError,data:comment,};e.preventDefault();$.ajax(config);}
$(document).ready(function(){$('body').on('submit','form.like',processLike);$('body').on('submit','form.report',processReport);$('body').on('submit','.new-comment',postComment);});;function onDweetChanged(){var charCount=$(this).parent().parent().parent().find('.character-count')[0];var submitButton=$(this).parent().parent().find('.remix-button,.dweet-button')[0];let CountCharacters=string=>{return[...string].length;};let characterCount=CountCharacters(this.value);charCount.textContent=characterCount+'/140';if(characterCount>140){$(charCount).addClass('too-long');$(submitButton).prop('disabled',true);}else{$(charCount).removeClass('too-long');$(submitButton).prop('disabled',false);}}
$(document).ajaxComplete(function(){$('.code-input').each(onDweetChanged);});$(document).ready(function(){function requestFullscreen(el){(el.mozRequestFullScreen||el.webkitRequestFullscreen||el.requestFullscreen).call(el);}
$('body').on('input','.code-input',onDweetChanged);$('.code-input').each(onDweetChanged);$('body').on('click','.fullscreen-button',function(e){var dweetCard=$(this).closest('.dweet');var iframe=$(dweetCard).find('iframe.dweetiframe');e.preventDefault();requestFullscreen(iframe[0]);});$('body').on('click','.comments a.show-more-comments',function(e){var target=$(e.target);e.preventDefault();target.parent().parent().find('.comment.hidden').removeClass('hidden');target.remove();});$('body').on('click','[data-popover]',function(e){var dweetCard=$(this).closest('.dweet');var $popover=$(dweetCard).find($(this).data('popover'));var shareLink=$popover.find('.share-link');e.preventDefault();if($popover.is(':visible')){$popover.hide();}else{$('.popover').hide();$popover.show();if($(this).data('popover')==='.share-container'){shareLink.select();}}});$('body').on('click','.record-button',function(){var recordButton=$(this)[0];var iframe=document.getElementById(recordButton.dataset.dweet_id);var span=recordButton.getElementsByTagName('span')[0];if(recordButton.classList.contains('recording')){iframe.contentWindow.postMessage('stopGifRecord','*');recordButton.classList.remove('recording');recordButton.classList.add('processing');span.innerHTML='processing';}else if(!recordButton.classList.contains('processing')){iframe.contentWindow.postMessage({msg:'startGifRecord',dweetId:recordButton.dataset.dweet_id,username:recordButton.dataset.username},'*');recordButton.classList.add('recording');span.innerHTML='recording';}else if(recordButton.classList.contains('processing')){iframe.contentWindow.postMessage('abortGifProcessing','*');recordButton.classList.remove('processing');span.innerHTML='record';}});$('body').on('click',function(e){if(!$(e.target).is('[data-popover]')&&$(e.target).closest('.popover').length===0){$('.popover').hide();}});$('body').on('focus','.share-link, .embed-src',function(){$(this).select();});moment.locale(navigator.userLanguage||navigator.language||'en-US');$('.dweet-timestamp').each(function(_,element){var postedDate=moment.utc($(element).find('time').attr('datetime'));$(element).text(postedDate.local().format('lll'));});$('.dweet-create-form-title').click(function(){var dweet=$('.submit-box').slideDown(Waypoint.refreshAll);var iframe=$(dweet).find('.dweetiframe')[0];registerOnKeyListener(dweet);registerWaypoint(iframe);$(dweet).find('textarea').focus();});});